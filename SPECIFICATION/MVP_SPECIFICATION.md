# Aibond MVP版 製品仕様書

**バージョン**: 1.0
**最終更新**: 2025年11月29日
**ステータス**: 実装前・仕様確定中

---

## 目次

1. [製品概要](#1-製品概要)
2. [MVP機能一覧](#2-mvp機能一覧)
3. [画面構成と遷移](#3-画面構成と遷移)
4. [機能詳細仕様](#4-機能詳細仕様)
5. [UI/UXデザイン仕様](#5-uiuxデザイン仕様)
6. [ユーザーフロー](#6-ユーザーフロー)
7. [制約事項](#7-制約事項)

---

## 1. 製品概要

### 1.1 コンセプト

**「言葉の壁を越えて、大切な人との絆を深める」**

Aibondは、国際パートナーのための会話記録・翻訳支援ツール。
2人が**共通のメイン言語**で会話し、理解が浅い人のために**リアルタイムで翻訳**。
誰が何を話したか（話者識別）を明確にし、「約束したこと」を自動で整理。
大切な会話を記録として残し、2人の関係をより深いものにする。
- メイン言語での会話をリアルタイム文字起こし + 話者識別（誰が話したか） + サブ言語へ翻訳 + AI自動整理


### 1.2 ターゲットユーザー

- **国際パートナー・夫婦**（外国人 × 外国人）
   - アプリ上は「日本語と英語」のテキスト
   - googleで対応している文字起こしと翻訳が言語対象とする
- **年齢層**: 20代〜40代
- **利用シーン**: 週1回の話し合い、大切な会話の記録

### 1.3 解決する課題

1. 言葉の壁（細かいニュアンスが伝わらない）
2. 「言った・言わない」の水掛け論
3. 約束したことを忘れてしまう
4. 後から会話を振り返りたい

### 1.4 MVP版の方針

**「最小限の機能で、コアバリューを検証する」**

- ✅ リアルタイム文字起こし（メイン言語1つ）+ 翻訳（サブ言語1つ）
- ✅ **話者識別（2人）** - 誰が話したかを明確に
- ✅ 会話記録の保存
- ✅ AI自動整理（トークサマリー）
- ✅ 約束リスト（Googleカレンダー連携は将来実装）

### 1.5 インフラ方針（確定）

- **アプリケーション/API**: Next.js を Cloud Run にデプロイ（SSR と API Routes を同居）
- **認証/DB/Storage**: Supabase（Auth + Postgres + Storage + RLS）
- **外部AI/音声**: Google Cloud Speech-to-Text（ストリーミング + 話者識別）、Google Translation、Gemini 2.5（要約・相談）
- **Secrets**: Cloud Secret Manager で管理し Cloud Run に注入（Supabase Service Role Key もここに集約）

---

## 2. MVP機能一覧

### 2.1 実装する機能（優先度: HIGH）

| # | 機能 | 説明 | 実装理由 |
|---|------|------|---------|
| 1 | **認証・アカウント管理** | メール/Google | 必須機能 |
| 2 | **パートナーアカウント連携** | 2人のアカウントを紐付け | コア機能 |
| 3 | **リアルタイム会話記録** | メイン言語の文字起こし + 話者識別（2人） + サブ言語への翻訳 | 最重要機能 |
| 4 | **トーク開始/終了** | セッション管理 | 必須機能 |
| 5 | **トークサマリー生成** | AI自動整理（話したこと、約束） - Gemini 2.5使用 | 差別化機能 |
| 6 | **約束リスト** | 約束の管理・チェックリスト | コア機能 |
| 7 | **会話履歴** | 過去のトーク一覧・詳細表示 | 必須機能 |
| 8 | **相談機能** | 生成AI（gemini）とユーザーが個別相談（過去のトークサマリ）、相手側は見れないこと| 必須機能 |
| 9 | **音声会話の保存** | 音声録音を保存（目的はアプリ売却時にデータとして希少性が高いデータ） | 確定ではない |
| 10 | **言語設定** | メイン言語（会話で使う言語）+ サブ言語（翻訳先）の設定 | 必須機能 |
| 11 | **サブスクリプション** | （課金はStripe予定））料金プラン・決済（Stripe） | 収益化 |
| 12 | **使用時間トラッキング** | 月間使用時間の管理 | プラン制限 |
| 13 | **AI相談チャット（個人用）** | Gemini 2.5と会話履歴を元に相談できる機能（初期はパスワード保護なし） | 差別化機能 |
| 14 | **音声データ保存** | トークの音声を保存（将来の再生用） | データ保全 |

### 2.2 将来実装する機能（優先度: MEDIUM）

| # | 機能 | 説明 | 後回しの理由 |
|---|------|------|-------------|
| 11 | **Googleカレンダー連携** | 約束をGoogleカレンダーに追加 | OAuth連携が必要、MVP後に検討 |
| 12 | **記念日機能** | 1年前の今日、記念日通知 | MVPに必須ではない |
| 13 | **共有メモ** | 2人で編集できるメモ | 別アプリで代替可能 |
| 14 | **感情分析** | 会話のトーン分析 | 精度検証が必要 |
| 15 | **プッシュ通知** | 約束のリマインダー等 | Web版では制限あり |
| 16 | **検索機能** | 会話履歴の全文検索 | データ量少ない段階では不要 |

### 2.3 実装しない機能（優先度: LOW）

| # | 機能 | 説明 | 実装しない理由 |
|---|------|------|---------------|
| 17 | **ビデオ通話** | アプリ内でのビデオ通話 | Zoom/Google Meet等で代替可能 |
| 18 | **チャット機能** | テキストチャット | LINE等で代替可能 |
| 19 | **グループ会話** | 3人以上の会話記録 | パートナー向けに特化 |
| 20 | **エンドツーエンド暗号化** | 完全な暗号化 | 技術的に複雑、後で検討 |


---

## 3. 画面構成と遷移

### 3.1 画面一覧

| # | 画面名 | URL | 説明 |
|---|--------|-----|------|
| 1 | ランディングページ | `/` | サービス紹介 |
| 2 | サインアップ | `/signup` | 新規登録 |
| 3 | ログイン | `/login` | ログイン |
| 4 | パートナー連携 | `/partner/setup` | パートナーとの連携設定 |
| 5 | ホーム | `/home` | メインダッシュボード |
| 6 | トーク画面 | `/talk/[talkId]` | リアルタイム会話記録 |
| 7 | トークサマリー | `/talk/[talkId]/summary` | 会話の要約表示 |
| 8 | 会話履歴 | `/history` | 過去のトーク一覧 |
| 9 | 約束リスト | `/promises` | 約束の管理 |
| 10 | AI相談チャット | `/ai-chat` | Geminiと個人的に相談（初期はパスワード保護なし） |
| 11 | 設定 | `/settings` | アカウント・言語設定 |
| 12 | プラン選択 | `/plans` | 料金プラン・決済 |

### 3.2 ランディングページ詳細

**URL**: `/`

**目的**: サービスの価値を伝え、新規登録へ誘導

**構成**
```
┌─────────────────────────────────────┐
│ [ヘッダー]                           │
│  ロゴ | ログイン | 無料で始める       │
├─────────────────────────────────────┤
│ [ヒーローセクション]                  │
│  キャッチコピー                      │
│  「言葉の壁を越えて、大切な人との絆を深める」│
│  サブコピー                          │
│  「国際パートナーのための会話記録・翻訳アプリ」│
│  [無料で始める] ボタン               │
├─────────────────────────────────────┤
│ [機能紹介セクション]                  │
│  ・リアルタイム文字起こし + 翻訳      │
│  ・誰が話したか明確に（話者識別）     │
│  ・AI が会話を自動整理               │
│  ・約束を忘れない                    │
├─────────────────────────────────────┤
│ [料金プランセクション]                │
│  Free / スタンダード / プレミアム    │
├─────────────────────────────────────┤
│ [フッター]                           │
│  利用規約 | プライバシーポリシー      │
└─────────────────────────────────────┘
```

**画面要素**
- ヘッダー: 固定ナビゲーション（スクロール時も表示）
- ヒーローセクション: 大きなキャッチコピー + CTA ボタン
- 機能紹介: アイコン + 説明文（4つの主要機能）
- 料金プラン: 3カラム比較表
- フッター: 法的リンク、SNSリンク

**レスポンシブ対応**
- モバイル: 1カラム、縦スクロール
- デスクトップ: セクションごとに最適化

### 3.3 画面遷移フロー

```
[ランディング] → [サインアップ] → [パートナー連携] → [ホーム]
                                                      ↓
                                    ┌─────────────────┼─────────────────┐
                                    ↓                 ↓                 ↓
                              [トーク開始]      [会話履歴]        [約束リスト]
                                    ↓                 ↓
                            [トーク画面]      [トーク詳細]
                                    ↓
                          [トークサマリー]
```

---

## 4. 機能詳細仕様

### 4.1 認証・アカウント管理

**実装内容**
- Supabase Authを使用
- 認証方法: メールアドレス、Google
- パスワードリセット機能（Supabase標準機能）
- パスワード変更機能（Supabase標準機能）

**データ保存**
- ユーザーテーブル: `users`
  - id (uuid)
  - email (string)
  - name (string)
  - language (string) - 母語（例: "ja", "en"）
  - created_at (timestamp)

**画面要素**
- サインアップフォーム: メール、パスワード、名前、母語
- ログインフォーム: メール、パスワード

### 4.2 パートナーアカウント連携

**基本方針**
- **連携は任意**。1人でもアプリの主要機能を使用可能
- 連携すると、パートナーとデータを共有できる
- 連携前の過去データも、連携後に相手に共有される

---

#### 4.2.1 連携なし（1人で使用）

**使用可能な機能**
| 機能 | 説明 |
|------|------|
| トーク開始・記録 | 1人でトークを開始し、会話を記録できる |
| リアルタイム文字起こし | 話者識別（2人）も動作する |
| 翻訳 | サブ言語が設定されていれば翻訳される |
| トークサマリー | AI要約が生成される |
| 約束リスト | 自分だけの約束リストとして管理 |
| 会話履歴 | 自分のトーク履歴を閲覧 |
| AI相談チャット | Geminiに相談可能 |

**ユースケース**
- 「パートナーに許可を取って、会話を記録したい」
- 「メモ代わりに話し合いを残したい」
- 「相手はアプリを使わないが、自分だけ記録を残したい」

**注意事項**
- 相手への録音許可は**ユーザーの責任範囲**
- 口頭で「記録を残すね」と伝えることを推奨（利用規約に記載）

---

#### 4.2.2 連携あり（2人で使用）

**実装内容**
- 2人のアカウントを1つの「パートナーアカウント」に紐付け
- 招待リンク方式: 片方が招待リンクを生成 → もう片方が承認

**連携フロー**
1. ユーザーAが「パートナーを招待」ボタンをクリック
2. 招待リンク生成（有効期限: 7日間）
3. リンクをパートナーに共有（LINE、メール等）
4. ユーザーBがリンクからアクセス → 承認
5. **過去のトークを共有するか確認**（両者に確認ダイアログ）
6. パートナーアカウント作成完了

---

#### 4.2.3 連携後の共有範囲

**共有されるもの（両者がアクセス可能）**
| 項目 | 説明 |
|------|------|
| トーク（会話記録） | 連携後のトークは両者に表示（**履歴閲覧のみ、リアルタイム共有はなし**） |
| **過去のトーク** | 連携前のトークも相手に共有される |
| 会話履歴 | すべてのトーク一覧を両者が閲覧可能 |
| トークサマリー | AI生成の要約を両者が閲覧可能 |
| 約束リスト | 抽出された約束を両者が確認・完了マーク可能 |
| 言語設定 | メイン言語・サブ言語はパートナー単位で設定 |

**個人で管理されるもの**
| 項目 | 説明 |
|------|------|
| サブスクリプション | 課金は個人単位（各自で契約） |
| 使用時間 | 月間上限は個人単位でカウント（セッション開始者の使用量） |

**共有されないもの（個人のまま）**
| 項目 | 説明 |
|------|------|
| AI相談チャット | 自分だけの相談履歴。相手は閲覧不可 |
| ユーザープロフィール | 名前、母語は個人設定 |
| 認証情報 | メール、パスワードは個人管理 |

---

#### 4.2.4 連携解除

**解除フロー**
1. 設定画面 → 「連携を解除」
2. 確認ダイアログ（「解除すると、パートナーとの連携が解除されます」）
3. 解除実行
4. **どちらか一方が解除 → 両者とも解除される**

**解除後のデータ**
- 連携中に作成されたトーク: **両者の履歴に残る**
- 約束リスト: **両者の履歴に残る**
- サブスクリプション: 個人単位なので影響なし（各自のプラン継続）

**履歴全削除機能**
- 設定画面に「連携履歴をすべて削除」ボタン
- 他の人とパートナーになる場合に、過去のパートナーとの履歴を削除したい場合に使用
- 確認ダイアログ: 「この操作は取り消せません。過去の連携パートナーとのトーク履歴、約束がすべて削除されます」
- **アカウント削除とは異なる**（アカウント自体は残る）
- 削除対象:
  - 過去の連携パートナーとのトーク（partnership_idで紐付いたもの）
  - 過去の連携パートナーとの約束
  - AI相談履歴は削除しない（個人データのため）

---

**データ保存**
- パートナーテーブル: `partnerships`
  - id (uuid)
  - user1_id (uuid)
  - user2_id (uuid)
  - partnership_name (string) - 例: "太郎 & Sarah"
  - main_language (string) - 会話で使う言語（例: "ja", "en"）
  - sub_language (string, **NULLABLE**) - 翻訳先の言語（例: "en", "ja"）。NULLの場合は翻訳OFF
  - created_at (timestamp)

**画面要素**
- 招待リンク生成ボタン
- リンクのコピー機能
- 招待承認画面
- 過去トーク共有確認ダイアログ
- 連携解除ボタン（設定画面）

**招待・連携ルール**
- 招待コード有効期限: 7日
- 期限切れ/無効コードはエラー表示、再発行可能
- 既にパートナーが成立しているユーザーが別招待を受けた場合は拒否し、現在のパートナー解除を促す文言を表示
- パートナー解除後のデータ扱い: デフォルトで保持（永続）、非公開アーカイブ化。ユーザーからは閲覧・共有・編集・新規追加不可（内部保管のみ）。
- 新しいパートナーと連携する際は、一括削除ボタンで旧データを削除可能（押さなくても旧データを保持したまま新パートナーと連携可）

### 4.3 リアルタイム会話記録

**実装内容**
- Google Cloud Speech-to-Text APIで音声認識
- **話者識別（Speaker Diarization）**で2人を区別 ← 重要機能
- Google Cloud Translation APIでリアルタイム翻訳
- **WebSocket**でリアルタイム双方向通信（Web/React Native両対応）

**言語処理の流れ**
1. 2人が**メイン言語（1つ）**で会話
   - 例: 2人とも日本語で話す
2. Google STT APIで音声認識 + 話者識別
   - 話者1（太郎）: 「今週末どうする？」
   - 話者2（Sarah）: 「映画に行きたい！」
3. **サブ言語（1つ）**にリアルタイム翻訳
   - 太郎: "What should we do this weekend?"
   - Sarah: "I want to go to the movies!"
4. 画面に表示（原文 + 翻訳。サブ言語がNULLの場合は翻訳欄を非表示）

**フロー**
1. 「トークを始める」ボタンをクリック
2. マイク権限を要求
3. 音声入力開始
4. リアルタイムで以下を実行:
   - 音声認識（メイン言語）
   - 話者識別（誰が話したか）
   - 翻訳（サブ言語へ）※サブ言語がNULLの場合はスキップ
   - 画面表示（発言者ごとに色分け）
5. （任意）「一時停止」ボタンで録音を一時停止
6. （任意）「再開」ボタンで録音を再開
7. 「トーク終了」ボタンでセッション終了

**一時停止/再開機能**
- トーク中に「一時停止」ボタンを押すと、音声入力を停止
- 「再開」ボタンで音声入力を再開
- 一時停止中も画面は維持（これまでの文字起こし結果を表示）
- 一時停止中の時間はトーク時間（duration_minutes）にカウントしない
- ユースケース: 休憩を挟む、別の話題で中断、プライベートな会話を除外

**データ保存**
- トークテーブル: `talks`
  - id (uuid)
  - partnership_id (uuid)
  - started_at (timestamp)
  - ended_at (timestamp)
  - duration_minutes (integer)
  - status (string) - "active", "completed"

- メッセージテーブル: `talk_messages`
  - id (uuid)
  - talk_id (uuid)
  - speaker_id (uuid) - どちらが話したか
  - original_text (text)
  - original_language (string) - "ja" or "en"
  - translated_text (text)
  - timestamp (timestamp)
  - is_final (boolean) - Partial/Final

**画面要素**
- マイクボタン（録音開始/停止）
- リアルタイム文字起こし表示エリア
- 発言者の区別（色分け、アイコン）
- タイムスタンプ表示

**技術的な注意点**
- **WebSocket通信**:
  - Cloud Run上のWebSocketサーバー（Express + ws）で処理
  - 音声データ送信・STT結果受信・一時停止/再開を1本の接続で
  - SSEは採用しない（RN対応のためWSに統一）
  - 認証はSupabase Access Tokenをクエリパラメータで送信
- **話者識別（Speaker Diarization）の設定**:
  - Google STT APIの `enableSpeakerDiarization: true`
  - `diarizationSpeakerCount: 2`（2人固定、voice登録は行わない）
  - APIが返す `speakerTag` をUI上で自分/相手に固定マッピング、誤判定時はUIで手動修正を許容
  - モデルは会話時間で `latest_short` / `latest_long` を切り替え、精度が実用的に不足する場合のみ将来のvoice登録を検討
- **言語設定**:
  - メイン言語は Google STT対応言語から選択
  - 翻訳はサブ言語へ1回のみ実行（Translation対応言語、sub_languageがNULLの場合は翻訳スキップ）
- **音声データ形式**:
  - フォーマット: PCM16（16bit, 16kHz, mono）をWS送信
  - Web: AudioWorkletでPCM16に変換、base64エンコードして送信
  - React Native: expo-avで録音、同様にPCM16で送信
- **Partialの扱い**: Google STTのPartial結果は表示するが、DBには保存しない（Finalのみ保存）
- **自動確定タイマー**: 言語交換機能の実装を流用（2秒+句読点、5秒最大待機）
- **翻訳遅延許容**: Final結果から翻訳表示までの許容時間は、実装時に動作確認しながら決定
- **再接続**: 通信途絶から60秒以内の再接続は同一セッションに復帰（pause状態から再開）。60秒超はセッション終了扱い。

**話者識別の詳細仕様**
- **初回マッピング**: speaker 1 = セッション内で最初に話した人
- **話者のユーザー紐付け機能**:
  - セッション完了後、speaker 1 / speaker 2 を「誰か」設定できるUI
  - 過去のトークに遡って、話者を後から設定・変更可能
  - 話者設定を変更すると、サマリーや約束リストにも反映される
- **ソロ使用時（相手がアプリ未登録）**:
  - 2人の発言とも記録される（Speaker Diarizationで区別）
  - `speaker2_user_id` は NULL のまま
  - 話者マッピングダイアログで「Speaker 2 の名前」を入力可能（例: "田中さん"）
  - 設定した名前はサマリーや約束リストの表示に反映される
  - 未設定時は「Speaker 2」と表示
- **話者切り替わり頻度**: 高速な会話でのDiarization精度は実使用しながら評価・調整

**話者識別の将来拡張（Voiceprint）**
- 現在: Google STT Speaker Diarizationで話者1/2を区別（匿名の話者タグ）
- 方針: 現段階では声登録を行わない。STT精度が実用に足りない場合のみ、将来Voiceprint導入を再検討する

**オンライン通話（Zoom等）対応**
- MVPでは基本対応のみ（特別な処理なし）
- ユーザーがZoom/Google Meet等で通話しながら、ブラウザでAibondを開いてマイク入力を行う
- 画面共有やシステム音声のキャプチャは非対応（将来検討）
- 注意: オンライン通話中は相手の声もマイクに入る可能性あり（スピーカー使用時）

### 4.4 トークサマリー生成（AI自動整理）

**実装内容**
- トーク終了後、AIで会話内容を分析
- **Google Gemini 2.5 APIを使用**（Google APIに統一）
- **サマリー言語**: main_language（メイン言語）で生成
- 以下の項目を自動抽出:
  - 📝 **今日話したこと**: 3-5行の要約
  - ✅ **約束したこと**: アクションアイテム（配列）
  - 💭 **次回話すこと**: 積み残しトピック（配列）

**短い会話の取り扱い**
- 会話が短すぎる場合（例: 発言数5件以下、または合計文字数100文字以下）はサマリー生成をスキップ
- 「会話が短いため、サマリーは生成されませんでした」と表示
- ユーザーが手動で「サマリーを生成」ボタンを押すことで強制生成も可能

**Gemini API失敗時の挙動**
- 自動リトライ（最大2回）
- リトライ失敗時は「サマリーを生成できませんでした」ダイアログを表示
- 後から手動で「再生成」ボタンを押すことで再試行可能

**プロンプト例**
```
あなたは国際パートナーの会話を整理するアシスタントです。
以下の会話内容を分析し、JSON形式で返してください。

会話内容:
{conversation_text}

出力形式:
{
  "summary": "今日話したことの要約（3-5行）",
  "promises": ["約束1", "約束2"],
  "next_topics": ["次回話すこと1", "次回話すこと2"]
}
```

**データ保存**
- トークテーブルに追加:
  - summary (text)
  - promises (json) - 配列
  - next_topics (json) - 配列

**画面要素**
- トークサマリー表示画面
- セクションごとに分けて表示
- 「全文を見る」ボタン（全発言履歴へ遷移）
- サマリー生成に失敗した場合は静かに終了（手動再生成ボタンは出さない）

**話者マッピング確認ダイアログ**
- **トーク終了 → サマリー生成後に毎回表示**
- 「Speaker 1 は誰ですか？」「Speaker 2 は誰ですか？」
- 選択肢: 自分 / パートナー名 / 不明
- 設定後、サマリーと全発言履歴に名前が反映される
- 「後で設定する」ボタンで一旦スキップ可能
- 過去のトーク詳細画面からも設定・変更可能

### 4.5 約束リスト

**実装内容**
- AIが抽出した「約束したこと」を一覧表示
- チェックリスト形式
- 完了/未完了の管理
- **手動追加機能**: AIが見逃した約束をユーザーが手動で追加可能
- **編集機能**: 約束の内容を修正可能
- **削除機能**: 不要な約束を削除可能

**データ保存**
- 約束テーブル: `promises`
  - id (uuid)
  - partnership_id (uuid)
  - talk_id (uuid) - どのトークで約束したか（手動追加の場合はNULL可）
  - content (text) - 約束の内容
  - is_completed (boolean)
  - is_manual (boolean) - 手動追加かどうか（デフォルト: false）
  - created_at (timestamp)
  - completed_at (timestamp)
  - updated_at (timestamp)

**画面要素**
- 約束リスト（未完了/完了済み）
- チェックボックス（完了マーク）
- 「このトークを見る」リンク（元のトークに遷移）
- 「＋約束を追加」ボタン（手動追加）
- 各約束に「編集」「削除」ボタン（またはスワイプアクション）

**操作**
- チェックボックスクリック → 完了/未完了トグル
- 完了済みは下部に移動またはグレーアウト
- 手動追加: 「＋約束を追加」→ 内容入力 → 保存
- 編集: 約束をタップ → 内容修正 → 保存
- 削除: 削除ボタン → 確認ダイアログ → 削除

### 4.6 会話履歴

**実装内容**
- 過去のトーク一覧を表示
- タイムライン形式
- 各トークのサマリーを表示

**画面要素**
- トーク一覧（新しい順）
- 各項目に表示:
  - 日付・時刻
  - 所要時間
  - サマリーの冒頭（1-2行）
  - 約束の数（「✅ 3つの約束」）
- タップで詳細画面へ遷移

**トーク詳細画面**
- 全発言履歴（時系列）
- 発言者ごとに色分け
- 原文と翻訳を並べて表示
- トークサマリーセクション

### 4.7 言語設定

**実装内容**
- **メイン言語**: 2人が会話で使う共通言語（1つ）- 必須（Google STT対応言語から選択）
- **サブ言語**: リアルタイム翻訳先の言語（1つ）- **任意（NULL可、Google Translation対応言語から選択）**
- 翻訳が不要な場合はサブ言語を「なし」に設定可能（翻訳APIコスト削減）

**設定例**
| パターン | メイン言語 | サブ言語 | 説明 |
|---------|-----------|---------|------|
| 翻訳あり | 日本語 | English | 日本語で会話 → 英語に翻訳表示（英語話者用） |
| 翻訳あり | English | 日本語 | 英語で会話 → 日本語に翻訳表示（日本語話者用） |
| **翻訳なし** | 日本語 | なし | 2人とも日本語に堪能。文字起こしのみ実行 |
| **翻訳なし** | English | なし | 2人とも英語に堪能。文字起こしのみ実行 |

**翻訳が不要なケース**
- 2人ともメイン言語に十分な理解がある
- 文字起こし・記録機能だけで十分
- Translation APIコストを抑えたい

**対応言語**
- **メイン言語**: Google Speech-to-Text対応言語すべて（100言語以上）
- **サブ言語**: Google Cloud Translation対応言語すべて（100言語以上）
- UIでは主要言語を上位に表示（日本語、英語、韓国語、中国語など）

**データ保存**
- パートナーテーブルの `main_language` と `sub_language` カラム
  - main_language: Google STT言語コード（例: "ja-JP", "en-US"）（必須）
  - sub_language: Google Translation言語コード（例: "en", "ja"）または **NULL**（任意）

**翻訳トグル設定**
- トーク画面での翻訳表示モード（原文のみ / 翻訳のみ / 両方表示）
- **セッション中のみ保持**（永続化しない）
- 次回セッションではデフォルト「両方表示」に戻る

**画面要素**
- 言語選択ドロップダウン
  - メイン言語（会話で使う言語）: [日本語 ▼]
  - サブ言語（翻訳先の言語）: [翻訳しない ▼] / [English ▼] / ...
- 説明テキスト: 「2人が普段話す言語をメイン言語に設定してください。翻訳が必要な場合のみサブ言語を設定してください」
- 保存ボタン

**コスト考慮**
- Google Cloud Translation APIは従量課金（文字数ベース）
- 翻訳不要なパートナーが「なし」を選ぶことでコスト最適化

### 4.8 サブスクリプション

**課金モデル**
- **個人単位の課金**（パートナー単位ではない）
- 1人でも利用可能（Free/有料両方）
- パートナー連携しても、課金は各自で管理（パートナー割引なし）
- 有料プランのユーザーがセッション開始可能
- Freeプランのユーザーは、パートナーが開始したセッションの閲覧のみ可能
- 両者がセッション開始したい場合は、両者が有料プランに加入

**実装内容**
- 3つのプラン: Free / スタンダード / プレミアム
- Stripe Checkoutで決済
- サブスクリプション管理（アップグレード、ダウングレード、キャンセル）
- 上限超過: セッション中に上限を超えたらその時点でセッションを終了し、サマリー生成に進む（新規セッションは開始不可）
- 利用上限は「音声録音時間（分）」で計測し、月次の残時間が0の場合は新規トーク開始をブロック

**プラン詳細**
| プラン | 月額 | 利用時間 | セッション開始 | セッション閲覧 |
|--------|------|----------|--------------|--------------|
| Free | ¥0 | 2時間/月 | ✅ | ✅ |
| スタンダード | ¥1,980 | 15時間/月 | ✅ | ✅ |
| プレミアム | ¥2,980 | 40時間/月 | ✅ | ✅ |

**セッション開始権限**
- セッションを開始したユーザーの使用量がカウントされる
- Freeプランでもセッション開始可能（月2時間まで）
- パートナーがセッションを開始した場合、自分の使用量は消費されない（閲覧のみ）

**支払い失敗時の挙動**
- Stripe決済失敗 → **即時Freeプランに降格**（猶予期間なし）
- ユーザーに「決済に失敗しました。Freeプランに変更されました」とメール通知
- カード情報更新後、再度有料プランにアップグレード可能

**プラン変更ルール**
- **アップグレード（Free→スタンダード、スタンダード→プレミアム）**:
  - 即時適用
  - 残日数分を日割り課金（Stripe proration）
- **ダウングレード（プレミアム→スタンダード、有料→Free）**:
  - **期間終了まで現プランを維持**
  - 次の請求サイクルから新プランを適用
  - データは削除しない（閲覧可能、新規トーク作成はFree枠内のみ）

**無料枠の繰越**
- **繰越なし**: 今月2時間中1時間使用 → 翌月は2時間にリセット（3時間にはならない）

**データ保存**
- サブスクリプションテーブル: `subscriptions`
  - id (uuid)
  - **user_id (uuid)** - 個人単位で管理
  - plan (string) - "free", "standard", "premium"
  - status (string) - "active", "canceled", "past_due"
  - stripe_customer_id (string)
  - stripe_subscription_id (string)
  - current_period_end (timestamp)
  - cancel_at_period_end (boolean) - ダウングレード予約フラグ
  - scheduled_plan (string) - 次回適用予定のプラン
  - created_at (timestamp)

**画面要素**
- プラン選択画面（3つのカード）
- 各プランの比較表
- 「選択する」ボタン → Stripe Checkout
- 現在のプラン表示
- プラン変更・キャンセルボタン
- ダウングレード予約時は「次回更新日に○○プランに変更されます」と表示

### 4.9 使用時間トラッキング

**実装内容**
- **個人単位で使用量を管理**（セッション開始者の使用量にカウント）
- トーク開始/終了時刻から録音時間（分）を算出し `usage.minutes_used` に加算
- 最小課金単位: 15秒単位で切り上げ（例: 65秒 → 1.25分）
- クラッシュ/強制終了時は最後の受信タイムスタンプを終了時刻として計算
- 月間の累計使用時間を計算（例: 2025-11）
- プラン上限超過時は新規トーク開始を拒否し、上限に近づいたら事前に警告
- **月次リセット**: 新しい月のアクセス時に新レコード自動作成、古いレコードは履歴として保持

**使用量のカウントルール**
- セッションを開始したユーザー（owner_user_id）の使用量にカウント
- パートナーは閲覧のみなので、パートナーの使用量は消費されない
- 1人で使う場合も同様（自分がセッション開始 = 自分の使用量）

**データ保存**
- 使用状況テーブル: `usage`
  - id (uuid)
  - **user_id (uuid)** - 個人単位で管理
  - period (string) - "2025-11"（YYYY-MM）
  - minutes_used (integer)
  - minutes_limit (integer)
  - created_at (timestamp)
  - updated_at (timestamp)

**画面要素**
- ホーム画面に使用状況を表示
  - 「今月: 5時間 / 15時間」
- プログレスバー
- 上限に近づいたら警告
  - 「残り2時間です。プランのアップグレードを検討してください」
  - 残り時間が0になった時点で「残り時間ゼロになりました」と表示し、セッションを強制終了

### 4.10 AI相談チャット（個人用）

**実装内容**
- **Google Gemini 2.5 APIを使用**（Google APIに統一）
- 自分の会話履歴を元に、Geminiに相談できる機能
- 初期リリースではパスワード保護なし（将来PINロックを追加できる設計とする）
- 「今までのやり取りから、どう対応すれば良かったか」等を相談

**プライバシー**
- **パートナーは自分のAI相談履歴を閲覧できない**（完全にプライベート）
- AI相談データは個人単位で管理（パートナー単位ではない）

**参照する会話量**
- **デフォルト**: 直近5回のセッションのサマリーをコンテキストに渡す
- **詳細な質問への対応**: Function Calling機能を使用
  - 過去の特定トークについての質問の場合、DBから該当トークのメッセージを抽出
  - 例: 「先週の日曜日に何を話した？」→ 該当トークのtalk_messagesを取得して回答
- これにより、コンテキストウィンドウを節約しつつ、必要な情報は取得可能

**メッセージ送信上限**
- **月間100件**のメッセージ送信上限
- 上限到達時は「今月の相談回数上限に達しました」と表示
- 翌月1日にリセット

**チャット履歴の保持**
- **全履歴を永久保持**（古いものは削除しない）
- データとしての価値が高いため、すべての相談履歴を残す
- `chat_history` (JSONB) に全履歴を保存

**ユースケース例**
- 「前回の話し合いで、もっと良い言い方はなかったか？」
- 「パートナーの気持ちを理解するにはどうすれば？」
- 「次の会話で気をつけることは？」
- 「先週の約束は何だった？」（Function Callingで過去データ参照）

**データ保存**
- AI相談テーブル: `ai_consultations`
  - id (uuid)
  - user_id (uuid) - どちらのユーザーか
  - chat_history (jsonb) - チャット履歴
  - message_count (integer) - 今月のメッセージ数
  - period (string) - "2025-11"（YYYY-MM）
  - created_at (timestamp)
  - updated_at (timestamp)

**画面要素**
- チャット画面（Geminiとの対話）
- 「会話履歴を元に分析」ボタン（過去のトークを読み込んで分析）
- チャット履歴（過去の相談記録）

**プライバシー注意**
- パートナー非公開を保証するロックは初期実装しない（閲覧責任はユーザー）
- 将来PINロックを追加可能な設計とする
- 今月の残り相談回数表示

### 4.11 音声データ保存

**実装内容**
- トーク中の音声データをストレージに保存し、将来の解析・再生に備える
- MVPでは再生UIは用意せず、蓄積のみ

**データ保存**
- 音声ファイルテーブル: `audio_files`
  - id (uuid)
  - talk_id (uuid) - どのトークの音声か
  - file_path (string) - ストレージのパス
  - file_size (integer) - ファイルサイズ（バイト）
  - duration_seconds (integer) - 音声の長さ（秒）
  - created_at (timestamp)

**ストレージ**
- Supabase Storage（private バケット）に保存
- 推奨フォーマット: WebM/Opus 48kHz（ブラウザ収録→そのまま保存）
- ファイル名例: `{talk_id}.webm`
- 将来的に解析用途で FLAC 等に変換する場合はバッチ処理で別パスへ保存

**技術的な注意点**
- マイク入力をMediaRecorderでキャプチャ
- リアルタイム文字起こしと並行して音声を録音
- トーク終了時にBlobをアップロード
- ストレージコストを考慮し圧縮形式（Opus）を採用、再生用署名URLは発行しない運用
- 解約時は音声・会話データを非公開アーカイブに移し、1ヶ月の猶予後に自動削除（ユーザーの手動削除は即時）

**画面要素**（MVP版では非表示、将来実装時に使用）
- 会話履歴詳細画面に「音声を再生」ボタン
- 音声プレーヤー（再生、一時停止、早送り等）

---

## 5. UI/UXデザイン仕様

### 5.1 デザインコンセプト

**キーワード**: 温かみ、柔らかさ、親しみやすさ、安心感

### 5.2 カラーパレット

**メインカラー**
- プライマリ: `#FF7F7F` (コーラル)
- セカンダリ: `#FFB6C1` (パステルピンク)

**アクセントカラー**
- アクセント: `#FFD700` (ゴールド) - ボタン等
- サクセス: `#90EE90` (ライトグリーン) - 完了状態
- 警告: `#FFA500` (オレンジ) - 上限警告

**背景・テキスト**
- 背景: `#FFF8DC` (クリーム) / `#FFFFFF` (ホワイト)
- テキスト: `#333333` (ダークグレー)
- グレー: `#E0E0E0` (ライトグレー) - ボーダー等

### 5.3 タイポグラフィ

**フォント**
- 日本語: Noto Sans JP
- 英語: Inter

**サイズ**
- H1: 32px (ページタイトル)
- H2: 24px (セクション)
- H3: 20px (サブセクション)
- Body: 16px (本文)
- Small: 14px (補足情報)

### 5.4 コンポーネント

**ボタン**
- プライマリボタン: コーラル背景、白文字、角丸8px
- セカンダリボタン: 白背景、コーラル枠線、コーラル文字
- ホバー: 明度-10%

**カード**
- 背景: 白
- ボーダー: 1px solid #E0E0E0
- 角丸: 12px
- シャドウ: 0 2px 8px rgba(0,0,0,0.1)

**アイコン**
- サイズ: 24px（標準）
- 色: テーマカラーまたはダークグレー

### 5.5 レイアウト

**画面幅**
- モバイル: 100%（パディング16px）
- タブレット: 768px（中央寄せ）
- デスクトップ: 1024px（中央寄せ）

**レスポンシブ対応**
- モバイルファースト
- ブレークポイント: 640px, 768px, 1024px

---

## 6. ユーザーフロー

### 6.1 初回利用フロー

```
1. ランディングページ訪問
   ↓
2. 「無料で始める」ボタンをクリック
   ↓
3. サインアップ（メールアドレス、パスワード、名前、母語）
   ↓
4. メール認証
   ↓
5. パートナー連携画面
   ↓
6. 「パートナーを招待」→ リンク生成 → 共有
   ↓
7. パートナーがリンクからアクセス → 承認
   ↓
8. ホーム画面（パートナーアカウント完成）
   ↓
9. 「トークを始める」
   ↓
10. マイク権限許可
   ↓
11. 会話開始（リアルタイム文字起こし）
   ↓
12. 会話終了 → トークサマリー表示
```

### 6.2 日常利用フロー

```
1. ログイン
   ↓
2. ホーム画面
   ↓
3. 「トークを始める」
   ↓
4. 会話記録
   ↓
5. トークサマリー確認
   ↓
6. 約束リストに自動追加
```

### 6.3 プラン変更フロー

```
1. ホーム画面 → 「プランを変更」
   ↓
2. プラン選択画面
   ↓
3. プランを選択 → Stripe Checkout
   ↓
4. カード情報入力 → 支払い
   ↓
5. サブスクリプション開始
   ↓
6. ホーム画面に戻る（プラン反映）
```

---

## 7. 制約事項

### 7.1 技術的制約

**ブラウザ対応**
- **優先対応（Chromium系）**: Chrome 90+、Edge 90+
- **可能な範囲で対応**: Safari 14+、Firefox 88+
- ※ MVP版はChromium系を優先し、Safari/Firefoxは基本動作確認のみ

**モバイル対応**
- iOS 14+（Safari）
- Android 10+（Chrome）

**Safari音声入力の対応**
- iOS Safari 14.5+: AudioWorklet対応済み（推奨）
- iOS Safari 14.5未満: MediaRecorder APIによるフォールバック
  - WebM/Opus形式で録音 → サーバー側で処理
- ※ Safari特有の制限（ユーザー操作なしでの音声開始不可等）に注意

**PWA対応**
- **MVP版では対応しない**
- 将来的にホーム画面追加、プッシュ通知対応を検討

**オフライン対応**
- ネットワーク切断時の挙動:
  - エラートースト表示（「接続が切れました」）
  - 自動再接続を試行（exponential backoff、最大3回）
  - 再接続失敗時は録音を一時停止
  - 「接続を再試行」ボタン表示
- 完全オフラインでの録音は非対応（リアルタイムSTTが必須のため）

**音声入力**
- マイク権限が必要
- HTTPS必須（ローカルはlocalhost例外）

**リアルタイム性**
- Google STT APIの遅延: 1-3秒
- 翻訳の遅延: 0.5-1秒
- 合計: 1.5-4秒のラグあり

### 7.2 機能的制約

**MVP版の制限**
- 同時接続: 2人まで（パートナーのみ）
- 対応言語: メイン=Google STT対応言語、サブ=Google Translation対応言語
- 記録保存期間: サービス利用中は無制限。解約時は非公開アーカイブへ移行し、1ヶ月後に自動削除（ユーザー手動削除は即時）
- トーク時間上限: なし（プランの月間上限まで）

**プラン制限**
- Free: 2時間/月
- スタンダード: 15時間/月
- プレミアム: 40時間/月

### 7.3 セキュリティ・プライバシー

**データ保護**
- 会話内容は暗号化してDB保存（Supabaseの暗号化 at-rest を利用）
- 音声ファイルはSupabase Storageのprivateバケットに保存し、署名URLは発行しない
- HTTPS通信必須
- Supabase Row Level Security（RLS）でアクセス制御

**レートリミット（目安）**
- 認証/招待系: 10リクエスト/分/ユーザー
- トーク開始・終了・サマリー生成: 10リクエスト/分/ユーザー
- 汎用API: 60リクエスト/分/ユーザー
- WebSocket: 同時接続1本、音声送信は30メッセージ/秒目安（超過時は一時的にドロップ）
- HTTP APIとWebSocketは別カウントで管理

**削除機能**
- トーク削除: 可能（完全削除）
- アカウント削除: 可能（全データ削除）

**アカウント削除フロー**
1. 設定画面 → 「アカウントを削除」
2. 確認ダイアログ表示（「本当に削除しますか？この操作は取り消せません」）
3. パスワード再入力で本人確認
4. 削除実行:
   - ユーザーデータ削除（user_profiles）
   - パートナーが存在する場合、パートナーも解消
   - 関連するトーク、メッセージ、約束、音声ファイルすべて削除
   - Supabase Auth からユーザー削除
   - Stripe で有効なサブスクリプションがあればキャンセル
5. ログアウト → ランディングページへ遷移

**データ保持期間**
- 解約: 非公開アーカイブに移し1ヶ月後に自動削除（猶予期間中は管理者のみアクセス可）
- アカウント削除: すべて即時削除
- 将来的にGDPR対応が必要な場合は、削除リクエストに応じる機能を追加

**データエクスポート**
- **ユーザーによるデータダウンロード機能は提供しない**（MVP版）
- 将来的にGDPR対応で必要になった場合は検討

**第三者提供**
- 会話内容を第三者に提供しない
- AI分析のためにGoogle Geminiに送信（利用規約に明記）

### 7.4 エラーハンドリング

**音声認識エラー**
- マイク権限拒否: 権限設定の案内を表示
- **STT API一時的エラー**:
  - 自動リトライ（最大3回、exponential backoff）
  - リトライ中はユーザーに「再接続中...」と表示
- **STT APIリトライ失敗**:
  - セッションを終了
  - ダイアログで「音声認識に接続できませんでした。トークを終了します」と通知
  - それまでの録音データは保存
- ネットワーク切断: 自動再接続を試行、一定時間で復帰しない場合は警告表示

**翻訳エラー**
- Translation API失敗: 原文のみ表示、翻訳部分に「翻訳失敗」と表示
- リトライ不要（次の発言から再試行）

**AI分析エラー**
- **Gemini API失敗**: 自動リトライ（最大2回）
- リトライ失敗時: ダイアログで「サマリーを生成できませんでした」と表示
- 後から手動で「再生成」ボタンを押すことで再試行可能

**決済エラー**
- Stripe Checkout失敗: エラーメッセージ表示、再試行を促す
- Webhook処理失敗: ログ記録、手動確認フロー

**一般的なエラー表示**
- ユーザーに技術的な詳細は見せない（「エラーが発生しました」程度）
- 開発者向けログは Cloud Logging に記録
- 重大なエラーは Sentry に送信（オプション）

---

## 8. 開発チェックリスト

### 8.1 実装前の確認事項

- [ ] カラーパレットの最終確認
- [ ] 対応言語の確定（日英韓中で良いか？）
- [ ] AI分析プロンプトの調整
- [ ] Stripe本番環境の設定
- [ ] Google Cloud APIキーの取得

### 8.2 実装優先順位

**Week 1: 基盤**
- [ ] Next.jsプロジェクト初期化
- [ ] Supabase設定（認証、DB）
- [ ] 認証画面（サインアップ、ログイン）
- [ ] パートナー連携機能

**Week 2: コア機能**
- [ ] リアルタイム会話記録（STT + Translation）
- [ ] トーク開始/終了
- [ ] データ保存（talks, talk_messages）
- [ ] 会話履歴表示

**Week 3: AI機能**
- [ ] トークサマリー生成（Google Gemini API）
- [ ] 約束リスト機能
- [ ] UI/UXの調整（パートナー向けデザイン）

**Week 4: 決済・リリース準備**
- [ ] Stripe統合（サブスクリプション）
- [ ] 使用時間トラッキング
- [ ] ランディングページ
- [ ] テスト・バグ修正

---

**次のステップ**: 技術仕様書（TECHNICAL_SPECIFICATION.md）の作成
