# 話し合い分析ロジック

Aibondの「話し合い分析」機能の技術的な仕組みを説明します。

## 概要

話し合いの文字起こしデータを分析し、以下の4つの指標でスコアリングします：

| 指標 | 説明 | スコア範囲 |
|------|------|-----------|
| 総合スコア | 話し合いの質を総合的に評価 | 1〜10 |
| 建設度 | 前向きな話し合いができているか | 1〜10 |
| 相互理解度 | お互いの気持ちを理解し合えているか | 1〜10 |
| 感情安定度 | 感情の起伏が穏やかか | 1〜10 |

---

## 分析フロー

```
会話終了
    ↓
サマリー生成（Gemini）
    ↓
感情分析（Google Cloud Natural Language API）
    ↓
評価スコア生成（Gemini）
    ↓
結果保存
```

---

## 1. 感情バランスの分析（Google Cloud Natural Language API）

### 使用API
Google Cloud Natural Language API の `analyzeSentiment` を使用。

### 入力
- 話し合いの文字起こしテキスト（発言ごとに分析）

### 出力
各発言に対して以下が返される：
- **score**: -1.0 〜 +1.0（感情の方向性）
- **magnitude**: 0 〜 ∞（感情の強さ）

### 感情分類ロジック

```javascript
if (score > 0.20) {
  return "positive";  // ポジティブ
} else if (score < -0.20) {
  return "negative";  // ネガティブ
} else {
  return "neutral";   // ニュートラル
}
```

### 短文の扱い
- 10文字未満の短い発言でも、magnitude > 0.3 なら分析対象に含める
- 「ありがとう」「ごめんね」など短くても感情的に重要な発言を拾う

### 出力値
- `positive_ratio`: ポジティブ発言の割合（%）
- `neutral_ratio`: ニュートラル発言の割合（%）
- `negative_ratio`: ネガティブ発言の割合（%）

---

## 2. 感情安定度の計算

### 標準偏差とは？（簡単に言うと）

**「感情のばらつき具合」を数値化したもの。**

- 標準偏差が**小さい** → 発言ごとの感情が似ている → **安定した会話**
- 標準偏差が**大きい** → 発言ごとの感情がバラバラ → **感情的な起伏がある会話**

### 反転表示とは？

内部では「volatility（変動性）」として計算しているため、**数値が高いほど不安定**。
しかしユーザーには「安定度」として表示したいので、**11から引いて反転**する。

```
volatility_score = 3（変動が少ない = 安定）
    ↓ 反転
stability = 11 - 3 = 8（安定度8 = 高い = 良い）
```

### 具体例

#### 例1: 安定した会話
```
発言1: 「週末どこ行こうか」     → score: +0.1
発言2: 「海がいいな」          → score: +0.3
発言3: 「いいね、そうしよう」   → score: +0.4
発言4: 「何時に出発する？」    → score: +0.1
発言5: 「9時くらいでどう？」   → score: +0.2

平均: 0.22
各スコアと平均の差: 小さい（0.1〜0.2程度）
標準偏差: 0.12（小さい）
volatility_score: 2
安定度（表示）: 11 - 2 = 9 ✅ 高い
```

#### 例2: 感情的な会話
```
発言1: 「なんでまた遅刻したの？」  → score: -0.6
発言2: 「ごめん、電車が...」      → score: -0.2
発言3: 「いつもそう言うよね」     → score: -0.7
発言4: 「わかった、気をつける」   → score: +0.3
発言5: 「本当にお願いね」         → score: +0.1

平均: -0.22
各スコアと平均の差: 大きい（0.3〜0.5程度）
標準偏差: 0.40（大きい）
volatility_score: 8
安定度（表示）: 11 - 8 = 3 ⚠️ 低い
```

### volatility_scoreの計算（具体例）

標準偏差を1〜10のスコアに変換する流れ：

```
【例1: 安定した会話】
感情スコア: [+0.1, +0.3, +0.4, +0.1, +0.2]

Step 1: 平均を計算
  平均 = (0.1 + 0.3 + 0.4 + 0.1 + 0.2) ÷ 5 = 0.22

Step 2: 各値と平均の差の2乗を計算
  (0.1 - 0.22)² = 0.0144
  (0.3 - 0.22)² = 0.0064
  (0.4 - 0.22)² = 0.0324
  (0.1 - 0.22)² = 0.0144
  (0.2 - 0.22)² = 0.0004

Step 3: 分散（平均の差の2乗の平均）
  分散 = (0.0144 + 0.0064 + 0.0324 + 0.0144 + 0.0004) ÷ 5 = 0.0136

Step 4: 標準偏差（分散の平方根）
  標準偏差 = √0.0136 ≒ 0.117

Step 5: スコアに変換（×20して1〜10に収める）
  volatility_score = round(0.117 × 20) = 2

→ volatility_score = 2（変動が小さい = 安定）
→ 安定度 = 11 - 2 = 9（高い = 良い）
```

```
【例2: 感情的な会話】
感情スコア: [-0.6, -0.2, -0.7, +0.3, +0.1]

Step 1: 平均 = -0.22
Step 2-3: 各値と平均の差が大きい → 分散 = 0.166
Step 4: 標準偏差 = √0.166 ≒ 0.407
Step 5: volatility_score = round(0.407 × 20) = 8

→ volatility_score = 8（変動が大きい = 不安定）
→ 安定度 = 11 - 8 = 3（低い = 要注意）
```

**ポイント**: 標準偏差 × 20 でスコア化。0.05（安定）→ 1、0.50（不安定）→ 10

### 解釈
- **volatility_score = 1〜3**: 感情が安定している（良い） → 安定度 8〜10
- **volatility_score = 4〜6**: 普通 → 安定度 5〜7
- **volatility_score = 7〜10**: 感情の起伏が大きい（要注意） → 安定度 1〜4

---

## 3. 建設度・相互理解度の評価（Gemini）

### 使用モデル
Gemini 1.5 Flash

### 入力
- 会話の文字起こし全文
- 感情分析結果（ポジティブ/ニュートラル/ネガティブの割合）
- 感情の変動幅（標準偏差）

### 評価プロンプト（日本語）

```
あなたはカップルカウンセリングの専門家です。
以下の話し合いを分析し、JSON形式で評価してください。

【評価基準】
- constructivenessScore（建設度）1-10:
  問題解決に向けた提案があるか、前向きな姿勢か

- understandingScore（相互理解度）1-10:
  相手の気持ちを理解しようとしているか、共感的な発言があるか

- overallScore（総合スコア）1-10:
  話し合い全体の質

【出力JSON】
{
  "constructivenessScore": 数値,
  "understandingScore": 数値,
  "overallScore": 数値,
  "goodPoints": ["良かった点1", "良かった点2"],
  "concerns": ["気になる点1"],
  "suggestions": ["アドバイス1"],
  "overallComment": "総評コメント"
}
```

---

## 4. 総合スコアの算出

総合スコアはGeminiが会話全体を評価して直接算出します。
以下の要素を総合的に考慮：

- 感情バランス（ポジティブ発言の割合）
- 感情の安定度
- 建設的な提案の有無
- 相互理解・共感の姿勢
- 話し合いの結論・合意の有無

---

## 5. トレンド（傾向）の計算

ダッシュボードに表示される「改善傾向」「安定」「低下傾向」の判定ロジック。

### 基本ルール

| 判定 | 条件 |
|------|------|
| 改善傾向 ↑ | 直近平均 - 過去平均 > 0.5 |
| 安定 → | 直近平均 ≥ 7（良いスコアを維持） **または** 差が±0.5以内 |
| 低下傾向 ↓ | 直近平均 < 7 **かつ** 過去より低下 |

**ポイント**:
- **改善は積極的に表示**（少しでも上がれば改善傾向）
- **高スコア（7以上）では低下傾向を表示しない**（微減は気にしない）
- **7未満に落ちたら低下傾向**を表示

---

### データ件数別の比較方法

| 件数 | 直近グループ | 過去グループ |
|------|-------------|-------------|
| 1件 | - | - → 「安定」固定 |
| 2件 | 1回目 | 2回目 |
| 3件 | 1回目 | 2,3回目の平均 |
| 4件 | 1,2回目の平均 | 3,4回目の平均 |
| 5件 | 1,2回目の平均 | 3,4,5回目の平均 |
| 6件以上 | 前半 | 後半（半分で分割） |
| 10件以上 | 直近5件 | 6〜10件目 |

---

### 具体例

#### 例1: 改善傾向（スコアが上がった）
```
データ: [8, 7, 6, 5, 5]（新しい順）
直近2回平均: (8 + 7) / 2 = 7.5
過去3回平均: (6 + 5 + 5) / 3 = 5.3

差分: 7.5 - 5.3 = +2.2（> 0.5）
→ 判定: 「改善傾向」↑
```

#### 例2: 安定（高スコアを維持）
```
データ: [7, 8, 8, 9]（新しい順）
直近2回平均: (7 + 8) / 2 = 7.5
過去2回平均: (8 + 9) / 2 = 8.5

差分: 7.5 - 8.5 = -1.0（下がっている）
しかし直近平均 7.5 ≥ 7（閾値）
→ 判定: 「安定」→（高スコア維持なので問題なし）
```

#### 例3: 低下傾向（閾値を下回った）
```
データ: [5, 6, 7, 8]（新しい順）
直近2回平均: (5 + 6) / 2 = 5.5
過去2回平均: (7 + 8) / 2 = 7.5

差分: 5.5 - 7.5 = -2.0
直近平均 5.5 < 7（閾値）
→ 判定: 「低下傾向」↓
```

#### 例4: 2件のみの場合
```
データ: [6, 8]（新しい順）
直近: 6
過去: 8

差分: 6 - 8 = -2.0
直近 6 < 7（閾値）
→ 判定: 「低下傾向」↓
```

---

### 感情安定度のトレンド（反転判定）

感情安定度は内部で「volatility（変動性）」として保存。**低いほど良い**ため判定が反転。

```
データ: [volatility 3, 4, 6, 7]（新しい順）
直近2回平均: 3.5
過去2回平均: 6.5

差分: 3.5 - 6.5 = -3.0（volatilityが減った）
→ 判定: 「改善傾向」↑（安定してきた = 良い）
```

**安定度での閾値判定**:
- volatility ≤ 4（= 安定度 ≥ 7）なら微増しても「安定」
- volatility > 4（= 安定度 < 7）で増加していたら「低下傾向」

---

## 6. 分析対象外となるケース

以下の場合は分析をスキップ：

| 条件 | skip_reason |
|------|-------------|
| 発言数が10件未満 | too_few_sentences |
| 合計文字数が200文字未満 | too_short |
| 話し合い時間が3分未満 | too_short_duration |

---

## データベース構造

### talk_sentiments テーブル

```sql
CREATE TABLE talk_sentiments (
  id UUID PRIMARY KEY,
  talk_id UUID REFERENCES talks(id),
  partnership_id UUID REFERENCES partnerships(id),
  status TEXT,  -- 'completed' | 'insufficient_data' | 'error'
  skip_reason TEXT,

  -- 感情バランス
  positive_ratio DECIMAL(5,2),
  neutral_ratio DECIMAL(5,2),
  negative_ratio DECIMAL(5,2),

  -- 話者別の感情バランス
  user1_positive_ratio DECIMAL(5,2),
  user1_negative_ratio DECIMAL(5,2),
  user2_positive_ratio DECIMAL(5,2),
  user2_negative_ratio DECIMAL(5,2),

  -- 生の分析値
  raw_volatility_stddev DECIMAL(10,4),
  sentence_count INTEGER,
  total_characters INTEGER,

  -- スコア（1-10）
  volatility_score INTEGER,
  constructiveness_score INTEGER,
  understanding_score INTEGER,
  overall_score DECIMAL(3,1),

  -- AIインサイト
  ai_insights JSONB,

  -- メタデータ
  talk_duration_minutes INTEGER,
  talk_time_of_day TEXT,
  talk_day_of_week INTEGER,
  analyzed_at TIMESTAMPTZ,
  analysis_version TEXT,
  analysis_language TEXT
);
```

---

## 関連ファイル

| ファイル | 説明 |
|---------|------|
| `src/lib/services/sentiment.ts` | Google NL API連携 |
| `src/lib/services/gemini-sentiment-eval.ts` | Gemini評価サービス |
| `src/app/api/sentiments/route.ts` | 分析結果取得API |
| `src/app/api/talks/[id]/analyze/route.ts` | 分析実行API |
| `src/app/analytics/page.tsx` | 分析結果表示ページ |
| `supabase/migrations/008_talk_sentiments.sql` | DBマイグレーション |

---

## 注意事項

- この分析はAIによる参考値であり、専門家による診断ではありません
- スコアはあくまで傾向を把握するための目安です
- 個々の話し合いの文脈や背景は考慮されていない場合があります
